<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Curate{% endblock %} — Editorial Dashboard</title>
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>
    <script src="https://unpkg.com/htmx-ext-sse@2.2.2/sse.js"></script>
    <script>
        (function() {
            var saved = localStorage.getItem('theme');
            if (saved === 'light' || saved === 'dark') {
                document.documentElement.setAttribute('data-theme', saved);
            } else if (window.matchMedia('(prefers-color-scheme: light)').matches) {
                document.documentElement.setAttribute('data-theme', 'light');
            } else {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();
    </script>
    <style>
        :root, [data-theme="dark"] {
            --bg: #0f1117;
            --surface: #1a1d27;
            --border: #2a2d3a;
            --text: #e4e4e7;
            --text-muted: #71717a;
            --accent: #6366f1;
            --accent-hover: #818cf8;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info-bg: #1e3a5f;
            --info-text: #60a5fa;
            --success-bg: #1a3329;
            --warning-bg: #3b2f1a;
            --danger-bg: #3b1a1a;
            --error-bg: #2d1515;
            --error-border: #5c2020;
            --error-text: #fca5a5;
        }
        [data-theme="light"] {
            --bg: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            --text: #0f172a;
            --text-muted: #64748b;
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --success: #16a34a;
            --warning: #d97706;
            --danger: #dc2626;
            --info-bg: #eff6ff;
            --info-text: #2563eb;
            --success-bg: #f0fdf4;
            --warning-bg: #fffbeb;
            --danger-bg: #fef2f2;
            --error-bg: #fef2f2;
            --error-border: #fecaca;
            --error-text: #dc2626;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }
        nav {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            gap: 2rem;
        }
        nav .logo {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--accent);
        }
        nav a {
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.2s;
        }
        nav a:hover { color: var(--text); }
        main {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }
        h1 { font-size: 1.5rem; margin-bottom: 1.5rem; }
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        .btn {
            display: inline-block;
            padding: 0.5rem 1rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            text-decoration: none;
            transition: background 0.2s;
        }
        .btn:hover { background: var(--accent-hover); }
        .btn-danger { background: var(--danger); }
        .badge {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .badge-submitted { background: var(--border); color: var(--text-muted); }
        .badge-fetching { background: var(--info-bg); color: var(--info-text); }
        .badge-reviewed { background: var(--success-bg); color: var(--success); }
        .badge-drafted { background: var(--warning-bg); color: var(--warning); }
        .badge-created { background: var(--border); color: var(--text-muted); }
        .badge-drafting { background: var(--info-bg); color: var(--info-text); }
        .badge-in_review { background: var(--warning-bg); color: var(--warning); }
        .badge-published { background: var(--success-bg); color: var(--success); }
        input[type="text"], input[type="url"], textarea, select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent);
        }
        select option {
            background: var(--bg);
            color: var(--text);
        }
        table { width: 100%; border-collapse: collapse; }
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        th { color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; }
        /* Agent run status badges */
        .badge-running { background: var(--info-bg); color: var(--info-text); }
        .badge-completed { background: var(--success-bg); color: var(--success); }
        .badge-failed { background: var(--danger-bg); color: var(--danger); }
        /* Stage-specific colors */
        .stage-fetch { color: var(--info-text); }
        .stage-review { color: var(--success); }
        .stage-draft { color: var(--warning); }
        .stage-edit { color: #a78bfa; }
        .stage-publish { color: var(--success); }
        /* Activity timeline */
        .activity-list { list-style: none; }
        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
        }
        .activity-item:last-child { border-bottom: none; }
        .activity-icon {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            flex-shrink: 0;
        }
        .activity-icon-running { background: var(--info-bg); color: var(--info-text); }
        .activity-icon-completed { background: var(--success-bg); color: var(--success); }
        .activity-icon-failed { background: var(--danger-bg); color: var(--danger); }
        .activity-body { flex: 1; min-width: 0; }
        .activity-header { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
        .activity-stage { font-weight: 600; font-size: 0.85rem; text-transform: capitalize; }
        .activity-time { color: var(--text-muted); font-size: 0.75rem; }
        .activity-trigger { color: var(--text-muted); font-size: 0.8rem; margin-top: 0.15rem; }
        .activity-error {
            margin-top: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: var(--error-bg);
            border: 1px solid var(--error-border);
            border-radius: 4px;
            color: var(--error-text);
            font-size: 0.8rem;
            font-family: monospace;
        }
        .activity-output-toggle {
            background: none;
            border: none;
            color: var(--accent);
            cursor: pointer;
            font-size: 0.8rem;
            padding: 0.25rem 0;
            margin-top: 0.25rem;
        }
        .activity-output-toggle:hover { color: var(--accent-hover); }
        .activity-output {
            margin-top: 0.5rem;
            padding: 0.75rem;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 300px;
            overflow-y: auto;
        }
        .activity-empty { color: var(--text-muted); font-size: 0.9rem; padding: 1rem 0; }
        /* Running spinner */
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .spinner { animation: pulse 1.5s ease-in-out infinite; }
        /* Link row agent indicator */
        .agent-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        .agent-indicator-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            display: inline-block;
        }
        .agent-indicator-dot-running { background: var(--info-text); animation: pulse 1.5s ease-in-out infinite; }
        .agent-indicator-dot-completed { background: var(--success); }
        .agent-indicator-dot-failed { background: var(--danger); }
        .theme-toggle {
            background: none;
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            padding: 0.3rem 0.5rem;
            font-size: 1rem;
            line-height: 1;
            color: var(--text-muted);
            transition: color 0.2s, border-color 0.2s;
        }
        .theme-toggle:hover { color: var(--text); border-color: var(--text-muted); }
        /* Compact pipeline step indicator (links table) */
        .pipeline-steps {
            display: flex;
            align-items: center;
            gap: 0.15rem;
            flex-wrap: wrap;
        }
        .pipeline-step {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .pipeline-step-icon {
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            flex-shrink: 0;
        }
        .pipeline-step-icon-completed { background: var(--success-bg); color: var(--success); }
        .pipeline-step-icon-failed { background: var(--danger-bg); color: var(--danger); }
        .pipeline-step-icon-running { background: var(--info-bg); color: var(--info-text); }
        .pipeline-step-arrow {
            color: var(--text-muted);
            font-size: 0.7rem;
            margin: 0 0.1rem;
        }
        .pipeline-step-error {
            margin-top: 0.35rem;
            padding: 0.35rem 0.6rem;
            background: var(--error-bg);
            border: 1px solid var(--error-border);
            border-radius: 4px;
            color: var(--error-text);
            font-size: 0.75rem;
            font-family: monospace;
        }
        .pipeline-prev-summary {
            color: var(--text-muted);
            font-size: 0.75rem;
            margin-top: 0.35rem;
            cursor: pointer;
        }
        .pipeline-prev-summary:hover { color: var(--accent); }
        .pipeline-prev-run {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.75rem;
            color: var(--text-muted);
            padding: 0.2rem 0;
        }
    </style>
</head>
<body>
    <nav>
        <span class="logo">Curate</span>
        <a href="/">Dashboard</a>
        <a href="/links">Links</a>
        <a href="/editions">Editions</a>
        <a href="/agents">Agents</a>
        <a href="/status">Status</a>
        <a href="/settings">Settings</a>
        <button class="theme-toggle" id="theme-toggle" type="button" title="Toggle theme" aria-label="Toggle theme" style="margin-left: auto;"></button>
        <a href="/auth/logout">Logout</a>
    </nav>
    <main>
        {% if request.app.state.processor is not none %}
        <!-- Single shared SSE connection for all pages -->
        <div hx-ext="sse" sse-connect="/events" style="display:none;">
            <div sse-swap="agent-run-start" hx-swap="none"></div>
            <div sse-swap="agent-run-complete" hx-swap="none"></div>
            <div sse-swap="link-update" hx-swap="none"></div>
        </div>
        {% endif %}
        {% block content %}{% endblock %}
    </main>
    <script>
        // Theme toggle
        (function() {
            var btn = document.getElementById('theme-toggle');
            function updateIcon() {
                var isDark = document.documentElement.getAttribute('data-theme') !== 'light';
                btn.textContent = isDark ? '\u2600' : '\u263E';
            }
            updateIcon();
            btn.addEventListener('click', function() {
                var isDark = document.documentElement.getAttribute('data-theme') !== 'light';
                var next = isDark ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', next);
                localStorage.setItem('theme', next);
                updateIcon();
            });
        })();

        // Handle agent run SSE events for live UI updates
        document.addEventListener('htmx:sseMessage', function(event) {
            var eventType = event.detail.type;
            var data;
            try { data = JSON.parse(event.detail.data); } catch(e) { return; }

            if (eventType === 'agent-run-start') {
                var feed = document.getElementById('activity-feed');
                if (feed) {
                    // Remove "no activity" placeholder
                    var empty = feed.querySelector('.activity-empty');
                    if (empty) empty.remove();
                    // Prepend new running run
                    var li = document.createElement('li');
                    li.className = 'activity-item';
                    li.id = 'run-' + data.id;
                    li.innerHTML = '<div class="activity-icon activity-icon-running"><span class="spinner">⟳</span></div>'
                        + '<div class="activity-body"><div class="activity-header">'
                        + '<span class="activity-stage stage-' + data.stage + '">' + data.stage + '</span>'
                        + '<span class="badge badge-running">running</span>'
                        + '<span class="activity-time">' + (data.started_at ? new Date(data.started_at).toLocaleTimeString() : '') + '</span>'
                        + '</div><div class="activity-trigger">Trigger: ' + (data.trigger_id || '').substring(0, 12) + '…</div></div>';
                    feed.prepend(li);
                }
            }

            if (eventType === 'agent-run-complete') {
                var el = document.getElementById('run-' + data.id);
                if (el) {
                    var icon = el.querySelector('.activity-icon');
                    var badge = el.querySelector('.badge');
                    if (data.status === 'completed') {
                        icon.className = 'activity-icon activity-icon-completed';
                        icon.innerHTML = '✓';
                        badge.className = 'badge badge-completed';
                        badge.textContent = 'completed';
                    } else {
                        icon.className = 'activity-icon activity-icon-failed';
                        icon.innerHTML = '✗';
                        badge.className = 'badge badge-failed';
                        badge.textContent = 'failed';
                    }
                    // Add duration
                    if (data.started_at && data.completed_at) {
                        var dur = ((new Date(data.completed_at) - new Date(data.started_at)) / 1000).toFixed(1);
                        var timeEl = el.querySelector('.activity-time');
                        if (timeEl) timeEl.textContent += ' · ' + dur + 's';
                    }
                    // Add output toggle if completed with output
                    if (data.output && data.status === 'completed') {
                        var body = el.querySelector('.activity-body');
                        var details = document.createElement('details');
                        details.innerHTML = '<summary class="activity-output-toggle">View output</summary>'
                            + '<div class="activity-output">' + JSON.stringify(data.output, null, 2) + '</div>';
                        body.appendChild(details);
                    }
                    // Add error display if failed
                    if (data.status === 'failed' && data.output) {
                        var body = el.querySelector('.activity-body');
                        var errDiv = document.createElement('div');
                        errDiv.className = 'activity-error';
                        errDiv.textContent = data.output.error || 'Unknown error';
                        body.appendChild(errDiv);
                    }
                }
            }

            if (eventType === 'link-update') {
                var row = document.getElementById('link-' + data.id);
                if (row) {
                    var statusBadge = row.querySelector('.badge');
                    if (statusBadge) {
                        statusBadge.className = 'badge badge-' + data.status;
                        statusBadge.textContent = data.status;
                    }
                    var titleCell = row.querySelectorAll('td')[1];
                    if (titleCell && data.title) titleCell.textContent = data.title;
                }
            }
        });
    </script>
</body>
</html>
