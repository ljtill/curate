<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Curate{% endblock %} — Editorial Dashboard</title>
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>
    <script src="https://unpkg.com/htmx-ext-sse@2.2.2/sse.js"></script>
    <script>
        (function() {
            var saved = localStorage.getItem('theme');
            if (saved === 'light' || saved === 'dark') {
                document.documentElement.setAttribute('data-theme', saved);
            } else if (window.matchMedia('(prefers-color-scheme: light)').matches) {
                document.documentElement.setAttribute('data-theme', 'light');
            } else {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();
    </script>
    <style>
        :root, [data-theme="dark"] {
            --bg: #0d1117;
            --surface: #161b22;
            --surface-secondary: #1c2128;
            --border: #30363d;
            --text: #e6edf3;
            --text-muted: #7d8590;
            --accent: #e6edf3;
            --accent-emphasis: #58a6ff;
            --accent-emphasis-hover: #79c0ff;
            --success: #3fb950;
            --success-bg: #0f2d16;
            --warning: #d29922;
            --warning-bg: #2d2000;
            --danger: #f85149;
            --danger-bg: #3d1114;
            --error-bg: #3d1114;
            --error-border: #5c2020;
            --error-text: #fca5a5;
        }
        [data-theme="light"] {
            --bg: #ffffff;
            --surface: #f6f8fa;
            --surface-secondary: #eaeef2;
            --border: #d1d9e0;
            --text: #1f2328;
            --text-muted: #59636e;
            --accent: #1f2328;
            --accent-emphasis: #0969da;
            --accent-emphasis-hover: #0550ae;
            --success: #1a7f37;
            --success-bg: #dafbe1;
            --warning: #9a6700;
            --warning-bg: #fff8c5;
            --danger: #d1242f;
            --danger-bg: #ffebe9;
            --error-bg: #ffebe9;
            --error-border: #fecaca;
            --error-text: #d1242f;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            font-size: 14px;
        }
        nav {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        nav .logo {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text);
        }
        nav a {
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.875rem;
            transition: color 0.15s;
        }
        nav a:hover { color: var(--text); }
        main {
            max-width: 1200px;
            margin: 1.5rem auto;
            padding: 0 1.5rem;
        }
        h1 { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; }
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            background: var(--surface);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8125rem;
            font-weight: 500;
            text-decoration: none;
            transition: background 0.15s, border-color 0.15s;
        }
        .btn:hover { background: var(--surface-secondary); border-color: var(--text-muted); }
        .btn-primary {
            background: var(--accent-emphasis);
            color: #ffffff;
            border-color: var(--accent-emphasis);
        }
        .btn-primary:hover { background: var(--accent-emphasis-hover); border-color: var(--accent-emphasis-hover); }
        .btn-danger {
            color: var(--danger);
            border-color: var(--danger);
            background: transparent;
        }
        .btn-danger:hover { background: var(--danger-bg); }
        .badge {
            display: inline-block;
            padding: 0.125rem 0.5rem;
            border-radius: 2rem;
            font-size: 0.75rem;
            font-weight: 500;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text-muted);
        }
        .badge-submitted { background: var(--surface); color: var(--text-muted); border-color: var(--border); }
        .badge-fetching { background: var(--surface); color: var(--accent-emphasis); border-color: var(--accent-emphasis); }
        .badge-reviewed { background: var(--success-bg); color: var(--success); border-color: transparent; }
        .badge-drafted { background: var(--warning-bg); color: var(--warning); border-color: transparent; }
        .badge-created { background: var(--surface); color: var(--text-muted); border-color: var(--border); }
        .badge-drafting { background: var(--surface); color: var(--accent-emphasis); border-color: var(--accent-emphasis); }
        .badge-in_review { background: var(--warning-bg); color: var(--warning); border-color: transparent; }
        .badge-published { background: var(--success-bg); color: var(--success); border-color: transparent; }
        input[type="text"], input[type="url"], textarea, select {
            width: 100%;
            padding: 0.375rem 0.75rem;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent-emphasis);
            box-shadow: 0 0 0 3px rgba(9, 105, 218, 0.15);
        }
        select option {
            background: var(--bg);
            color: var(--text);
        }
        table { width: 100%; border-collapse: collapse; }
        th, td {
            padding: 0.5rem 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        th { color: var(--text-muted); font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.03em; }
        .badge-running { background: var(--surface); color: var(--accent-emphasis); border-color: var(--accent-emphasis); }
        .badge-completed { background: var(--success-bg); color: var(--success); border-color: transparent; }
        .badge-failed { background: var(--danger-bg); color: var(--danger); border-color: transparent; }
        .stage-fetch { color: var(--accent-emphasis); }
        .stage-review { color: var(--success); }
        .stage-draft { color: var(--warning); }
        .stage-edit { color: var(--text-muted); }
        .stage-publish { color: var(--success); }
        .activity-list { list-style: none; }
        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
        }
        .activity-item:last-child { border-bottom: none; }
        .activity-icon {
            width: 1.75rem;
            height: 1.75rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            flex-shrink: 0;
        }
        .activity-icon-running { background: var(--surface-secondary); color: var(--accent-emphasis); }
        .activity-icon-completed { background: var(--success-bg); color: var(--success); }
        .activity-icon-failed { background: var(--danger-bg); color: var(--danger); }
        .activity-body { flex: 1; min-width: 0; }
        .activity-header { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
        .activity-stage { font-weight: 600; font-size: 0.8125rem; text-transform: capitalize; }
        .activity-time { color: var(--text-muted); font-size: 0.75rem; }
        .activity-trigger { color: var(--text-muted); font-size: 0.75rem; margin-top: 0.125rem; }
        .activity-error {
            margin-top: 0.375rem;
            padding: 0.375rem 0.625rem;
            background: var(--error-bg);
            border: 1px solid var(--error-border);
            border-radius: 4px;
            color: var(--error-text);
            font-size: 0.75rem;
            font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, monospace;
        }
        .activity-output-toggle {
            background: none;
            border: none;
            color: var(--accent-emphasis);
            cursor: pointer;
            font-size: 0.75rem;
            padding: 0.125rem 0;
            margin-top: 0.125rem;
        }
        .activity-output-toggle:hover { color: var(--accent-emphasis-hover); }
        .activity-output {
            margin-top: 0.375rem;
            padding: 0.5rem;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.75rem;
            font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, monospace;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 300px;
            overflow-y: auto;
        }
        .activity-empty { color: var(--text-muted); font-size: 0.875rem; padding: 0.75rem 0; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .spinner { animation: pulse 1.5s ease-in-out infinite; }
        .agent-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        .agent-indicator-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            display: inline-block;
        }
        .agent-indicator-dot-running { background: var(--accent-emphasis); animation: pulse 1.5s ease-in-out infinite; }
        .agent-indicator-dot-completed { background: var(--success); }
        .agent-indicator-dot-failed { background: var(--danger); }
        .theme-toggle {
            background: none;
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            line-height: 1;
            color: var(--text-muted);
            transition: color 0.15s, border-color 0.15s;
        }
        .theme-toggle:hover { color: var(--text); border-color: var(--text-muted); }
        .pipeline-steps {
            display: flex;
            align-items: center;
            gap: 0.125rem;
            flex-wrap: wrap;
        }
        .pipeline-step {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .pipeline-step-icon {
            width: 1.125rem;
            height: 1.125rem;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.5625rem;
            flex-shrink: 0;
        }
        .pipeline-step-icon-completed { background: var(--success-bg); color: var(--success); }
        .pipeline-step-icon-failed { background: var(--danger-bg); color: var(--danger); }
        .pipeline-step-icon-running { background: var(--surface-secondary); color: var(--accent-emphasis); }
        .pipeline-step-arrow {
            color: var(--text-muted);
            font-size: 0.625rem;
            margin: 0 0.0625rem;
        }
        .pipeline-step-error {
            margin-top: 0.25rem;
            padding: 0.25rem 0.5rem;
            background: var(--error-bg);
            border: 1px solid var(--error-border);
            border-radius: 4px;
            color: var(--error-text);
            font-size: 0.75rem;
            font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, monospace;
        }
        .pipeline-prev-summary {
            color: var(--text-muted);
            font-size: 0.75rem;
            margin-top: 0.25rem;
            cursor: pointer;
        }
        .pipeline-prev-summary:hover { color: var(--accent-emphasis); }
        .pipeline-prev-run {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            color: var(--text-muted);
            padding: 0.125rem 0;
        }
        .user-avatar {
            width: 1.75rem;
            height: 1.75rem;
            border-radius: 50%;
            background: var(--accent-emphasis);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            text-decoration: none;
            flex-shrink: 0;
        }
        .user-avatar:hover { opacity: 0.85; }
        .profile-field {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            font-size: 0.875rem;
        }
        .profile-label {
            color: var(--text-muted);
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <nav>
        <span class="logo">Curate</span>
        <a href="/">Dashboard</a>
        <a href="/store">Store</a>
        <a href="/settings">Settings</a>
        <button class="theme-toggle" id="theme-toggle" type="button" title="Toggle theme" aria-label="Toggle theme" style="margin-left: auto;"></button>
        {% set _user = request.session.get("user", {}) %}
        {% if _user %}
        <a href="/profile" class="user-avatar" title="{{ _user.get('name', 'Profile') }}">{{ _user.get("name", "?")[0] | upper }}</a>
        {% endif %}
    </nav>
    <main>
        {% if request.app.state.processor is not none %}
        <!-- Single shared SSE connection for all pages -->
        <div hx-ext="sse" sse-connect="/events" style="display:none;">
            <div sse-swap="agent-run-start" hx-swap="none"></div>
            <div sse-swap="agent-run-complete" hx-swap="none"></div>
            <div sse-swap="link-update" hx-swap="none"></div>
        </div>
        {% endif %}
        {% block content %}{% endblock %}
    </main>
    <script>
        // Theme toggle
        (function() {
            var btn = document.getElementById('theme-toggle');
            function updateIcon() {
                var isDark = document.documentElement.getAttribute('data-theme') !== 'light';
                btn.textContent = isDark ? '\u2600' : '\u263E';
            }
            updateIcon();
            btn.addEventListener('click', function() {
                var isDark = document.documentElement.getAttribute('data-theme') !== 'light';
                var next = isDark ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', next);
                localStorage.setItem('theme', next);
                updateIcon();
            });
        })();

        // Handle agent run SSE events for live UI updates
        document.addEventListener('htmx:sseMessage', function(event) {
            var eventType = event.detail.type;
            var data;
            try { data = JSON.parse(event.detail.data); } catch(e) { return; }

            if (eventType === 'agent-run-start') {
                var feed = document.getElementById('activity-feed');
                if (feed) {
                    // Remove "no activity" placeholder
                    var empty = feed.querySelector('.activity-empty');
                    if (empty) empty.remove();
                    // Prepend new running run
                    var li = document.createElement('li');
                    li.className = 'activity-item';
                    li.id = 'run-' + data.id;
                    li.innerHTML = '<div class="activity-icon activity-icon-running"><span class="spinner">⟳</span></div>'
                        + '<div class="activity-body"><div class="activity-header">'
                        + '<span class="activity-stage stage-' + data.stage + '">' + data.stage + '</span>'
                        + '<span class="badge badge-running">running</span>'
                        + '<span class="activity-time">' + (data.started_at ? new Date(data.started_at).toLocaleTimeString() : '') + '</span>'
                        + '</div><div class="activity-trigger">Trigger: ' + (data.trigger_id || '').substring(0, 12) + '…</div></div>';
                    feed.prepend(li);
                }
            }

            if (eventType === 'agent-run-complete') {
                var el = document.getElementById('run-' + data.id);
                if (el) {
                    var icon = el.querySelector('.activity-icon');
                    var badge = el.querySelector('.badge');
                    if (data.status === 'completed') {
                        icon.className = 'activity-icon activity-icon-completed';
                        icon.innerHTML = '✓';
                        badge.className = 'badge badge-completed';
                        badge.textContent = 'completed';
                    } else {
                        icon.className = 'activity-icon activity-icon-failed';
                        icon.innerHTML = '✗';
                        badge.className = 'badge badge-failed';
                        badge.textContent = 'failed';
                    }
                    // Add duration
                    if (data.started_at && data.completed_at) {
                        var dur = ((new Date(data.completed_at) - new Date(data.started_at)) / 1000).toFixed(1);
                        var timeEl = el.querySelector('.activity-time');
                        if (timeEl) timeEl.textContent += ' · ' + dur + 's';
                    }
                    // Add output toggle if completed with output
                    if (data.output && data.status === 'completed') {
                        var body = el.querySelector('.activity-body');
                        var details = document.createElement('details');
                        details.innerHTML = '<summary class="activity-output-toggle">View output</summary>'
                            + '<div class="activity-output">' + JSON.stringify(data.output, null, 2) + '</div>';
                        body.appendChild(details);
                    }
                    // Add error display if failed
                    if (data.status === 'failed' && data.output) {
                        var body = el.querySelector('.activity-body');
                        var errDiv = document.createElement('div');
                        errDiv.className = 'activity-error';
                        errDiv.textContent = data.output.error || 'Unknown error';
                        body.appendChild(errDiv);
                    }
                }
            }

            if (eventType === 'link-update') {
                var row = document.getElementById('link-' + data.id);
                if (row) {
                    var statusBadge = row.querySelector('.badge');
                    if (statusBadge) {
                        statusBadge.className = 'badge badge-' + data.status;
                        statusBadge.textContent = data.status;
                    }
                    var titleCell = row.querySelectorAll('td')[1];
                    if (titleCell && data.title) titleCell.textContent = data.title;
                }
            }
        });
    </script>
</body>
</html>
