{% extends "base.html" %}
{% from "partials/link_progress.html" import render_link_progress %}
{% block title %}Links{% endblock %}
{% block content %}
<h1>Links</h1>

{% if editions %}
<div class="card">
    <h2 style="font-size: 1rem; margin-bottom: 0.75rem;">Submit a Link</h2>
    <form method="post" action="/links" style="display: flex; gap: 0.5rem;">
        <select name="edition_id" style="margin-bottom: 0; width: auto; min-width: 200px;" onchange="window.location.href='/links/?edition_id=' + this.value">
            {% for ed in editions %}
            <option value="{{ ed.id }}" {% if edition and ed.id == edition.id %}selected{% endif %}>
                {{ ed.content.get('title', 'Untitled') or 'Untitled' }} ({{ ed.status }})
            </option>
            {% endfor %}
        </select>
        <input type="url" name="url" placeholder="https://example.com/article" required style="flex: 1; margin-bottom: 0;">
        <button type="submit" class="btn">Submit</button>
    </form>
</div>

<div class="card">
    <table>
        <thead>
            <tr>
                <th>URL</th>
                <th>Title</th>
                <th>Status</th>
                <th>Agent Progress</th>
                <th>Submitted</th>
            </tr>
        </thead>
        <tbody id="links-table">
            {% for link in links %}
            <tr id="link-{{ link.id }}">
                <td><a href="{{ link.url }}" target="_blank" style="color: var(--accent);">{{ link.url | truncate(50) }}</a></td>
                <td>{{ link.title or '—' }}</td>
                <td><span class="badge badge-{{ link.status }}">{{ link.status }}</span>
                    {% if link.status == 'failed' %}
                    <form method="post" action="/links/{{ link.id }}/retry" style="display: inline; margin-left: 0.25rem;">
                        <button type="submit" class="btn" style="padding: 0.15rem 0.5rem; font-size: 0.75rem;">Retry</button>
                    </form>
                    {% endif %}
                    <span class="delete-inline" style="margin-left: 0.25rem;">
                        <button type="button" class="btn btn-danger" style="padding: 0.15rem 0.5rem; font-size: 0.75rem;"
                                onclick="this.style.display='none'; this.nextElementSibling.style.display='inline';">Delete</button>
                        <span style="display: none;">
                            <span style="font-size: 0.75rem; color: var(--text-muted); margin-right: 0.25rem;">Delete?</span>
                            <form method="post" action="/links/{{ link.id }}/delete" style="display: inline;">
                                <input type="hidden" name="edition_id" value="{{ edition.id }}">
                                <button type="submit" class="btn btn-danger" style="padding: 0.15rem 0.5rem; font-size: 0.75rem;">Confirm</button>
                            </form>
                            <button type="button" class="btn" style="padding: 0.15rem 0.5rem; font-size: 0.75rem; margin-left: 0.15rem;"
                                    onclick="this.parentElement.style.display='none'; this.parentElement.previousElementSibling.style.display='inline';">Cancel</button>
                        </span>
                    </span>
                </td>
                <td>
                    {% set groups = link_run_groups.get(link.id, []) %}
                    {{ render_link_progress(groups) }}
                </td>
                <td style="color: var(--text-muted);">{{ link.created_at.strftime('%Y-%m-%d %H:%M') if link.created_at else '—' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="card">
    <p style="color: var(--text-muted);">No active editions. <a href="/editions" style="color: var(--accent);">Create one</a> to start submitting links.</p>
</div>
{% endif %}
{% endblock %}
